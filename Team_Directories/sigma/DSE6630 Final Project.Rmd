---
title: "DSE6630 Final Project"
author: "Ryan Canfield, and Malek Sabri"
date: "30 June 2024"
output:
  word_document:
    toc: true
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    fig_crop: false
subtitle: 'Merrimack College DSE6630: Healthcare & Life Sciences Analytics'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = FALSE,
                      cache.comments = TRUE,
                      size = 13)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Cleaning, setting up, and loading packages.
pacman::p_unload(pacman::p_loaded(), character.only = TRUE)
rm(list = ls(all = TRUE))

pacman::p_load(here,
               tidyverse, 
               ggplot2, 
               kableExtra,
               forcats,
               sf,
               tmap,
               tmaptools,
               jsonlite, 
               lubridate, 
               caret,
               glmnet, 
               gbm)

```

```{r}
# Loading in the data file.
OriginDF <- read.csv("MA_COUNTY_CANCER_MORTALITY_RATES_1980_2014.CSV")

# **Note** all the heads should be commented out when knitting to remove extra tables this is just a way to confirm and see if the code is working.
#head(OriginDF)

```
# 1 Introduction
## 1.1 Background
This data set shows the mortality rate of each cancer in Massachusetts. It is a record showing the number of deaths by county gender and year. Some of the important variable information is:

__location_name__  -- Is the county that is being measured/recorded.
__FIPS__ -- Is the unique value assigned by the government to identify geographic entities within the U.S..
__cause_name__ -- Is the type of cancer that caused the mortality.
__sex__ -- Is the sex of the patient. (Both is the combination of both the male and female rates).
__year_id__ -- Is the year that is being recorded. the years go from 1980 - 2014.
__mx__ -- Is the number of deaths caused by the cancer in that year.
__upper__ and __lower__ -- Are the upper and lower bounds of mx.

To read this data, we will use an example which can be found on line 106. On that line it says:
In the year 1980 there were an estimation of 305 male deaths due to Neoplasms cancer in Barnstable County	

The first 100 or so rows show the number for the entire state not, not by county so we removed the rose containing data that we didn't need.
```{r}
# Removes data that we didn't need.
df <- OriginDF[-(1:105), ]

#head(df)
```
Here we are reading in shape files found on the website below to get the county borders for massachusetts.
[here](https://www.mass.gov/info-details/massgis-data-counties?_gl=1*1atxnmf*_ga*MTAyOTc5ODQ4LjE3MTk2MTk0NDU.*_ga_MCLPEGW7WM*MTcxOTYxOTU2Ny4xLjEuMTcxOTYxOTU3Ni4wLjAuMA..#downloads-) 

```{r}
ma_sf <- read_sf("C:/Users/RRC/Downloads/counties/COUNTIESSURVEY_POLYM.shp") 
ma_sf$geometry

```

Reading in the shape file and looking at the geometry of it as well.
```{r, fig.height=3, fig.width=3}
# Initiate the plot and tell it the data set
ggplot(ma_sf) +
  # Use the geom_sf function to tell it how to make the map
  geom_sf() +
  # Set the theme to classic
  theme_classic() +
  # Let's give it a title
  ggtitle("Massachusetts")

```
## 1.2 Questions to examine 

1. Based on the data we have we can look at most most common cancer mortalities in the three counties with the lowest income compared to the highest income (look at incomes online ) and map then to compare. after finding results we can come pair either hospital numbers or poor insurance due to low income

top 3 highest
1. Nantucket
2. Norfolk
3. Middlesex

top 3 lowest
1. Hampden 
2. Berkshire
3. Franklin

2. We can use bar graphs and other visuals and aggregate the data to look at highest mortality cancer types between males females and both combined. From here we can come up with a few recommendations like creating more tests to watch out for these types of cancer, and seeing trends in mortalities and seeing if any new cancer arises as highest deaths.

# 2 Methods and Visualizations 
## 2.1 Question 1
### Wrangling, Preprocessing, and Mapping
```{r}
# Filtering data to include only the top three highest and top three lowest counties based on income. (We found these by researching)
filtered_data1 <- df %>%
  filter(location_name %in% c('Nantucket County', 'Norfolk County', 'Middlesex County', 
                              'Hampden County', 'Berkshire County', 'Franklin County') 
         & sex %in% c('Both'))

# Only including variables we need for the visual we don't need gender since it is all the same and we do not need year since we will be grouping the data next.
dfBoth <- filtered_data1[, c('FIPS', 'location_name', 'cause_name', 'mx')]  

# Grouping by cancer type and getting the average of each mortality rate from each year.
dfBothFinal <- dfBoth %>%
    group_by(FIPS, location_name, cause_name) %>%
    summarise(averge_mortality_rate = mean(mx)) 
```

```{r}
# Merge summarized data with spatial data (if necessary)
dfBothFinalMerged <- merge(ma_sf, dfBothFinal, by.x = "FIPS_ID", by.y = "FIPS", all.x = TRUE)

# Plot the map with ggplot2, labeling the top causes
ggplot(dfBothFinalMerged) +
  geom_sf(aes(fill = averge_mortality_rate), color = "black") +
  scale_fill_viridis_c(name = "Average Mortality Rate", label = scales::comma) +
  theme_minimal() +
  ggtitle("Highest Mortality Rate by County in Massachusetts") +
  labs(fill = "Average Mortality Rate") +
  theme(legend.position = "bottom")

# Sort and select top six counties by average mortality rate
top_causes <- dfBothFinalMerged %>%
  arrange(desc(averge_mortality_rate)) %>%
  slice_head(n = 6) %>%
  select(FIPS_ID, location_name, cause_name)
top_causes2 <- dfBothFinalMerged %>%
  arrange(desc(averge_mortality_rate)) %>%
  slice(7:12) %>%
  select(FIPS_ID, location_name, cause_name)

# Plot the map with ggplot2, labeling the top causes
ggplot(dfBothFinalMerged) +
  geom_sf(aes(fill = averge_mortality_rate), color = "black") +
  geom_sf_label(data = top_causes, aes(label = paste(location_name, cause_name, top_causes2$cause_name, sep = "\n")), size = 2.5) +  

  scale_fill_viridis_c(name = "Average Mortality Rate", label = scales::comma) +
  theme_minimal() +
  ggtitle("Highest Mortality Rate by County in Massachusetts") +
  labs(fill = "Average Mortality Rate") +
  theme(legend.position = "bottom")

```

```{r}
## Grouping by cancer type and getting the average of each mortality rate from each year.
#dfBothFinal <- dfBothFinal %>%
#  arrange(desc(averge_mortality_rate))
#
#dict <- tribble(
#  ~ Variable, ~ Description,
#  "Nantucket County (Highest income) -- Neoplasms", "Average Mortality Rate -- 239.00577",
#  "Hampden County (Lowest income) -- Neoplasms", "Average Mortality Rate -- 230.91646",
#  "Norfolk County (2nd Highest income) -- Neoplasms", "Average Mortality Rate -- 220.48933",
#  "Middlesex County (3rd highest income) -- Neoplasms", "Average Mortality Rate -- 217.44186",
#  "Berkshire County (2nd lowest income) -- Neoplasms", "Average Mortality Rate -- 217.25613",
#  "Franklin County (3rd lowest income) -- Neoplasms", "Average Mortality Rate -- 209.75202",
#  
#  "Nantucket County (Highest income) -- Tracheal, bronchus, and lung cancer	", "Average Mortality Rate -- 67.78133",
#  "Hampden County (Lowest income) -- Tracheal, bronchus, and lung cancer	", "Average Mortality Rate -- 65.18665",
#  "Norfolk County (2nd Highest income) -- Tracheal, bronchus, and lung cancer	", "Average Mortality Rate -- 61.35590",
#  "Berkshire County (2nd lowest income) -- Tracheal, bronchus, and lung cancer	", "Average Mortality Rate -- 60.89512",
#  "Middlesex County (3rd highest income) -- Tracheal, bronchus, and lung cancer	", "Average Mortality Rate -- 59.44581",
#  "Franklin County (3rd lowest income) -- Tracheal, bronchus, and lung cancer	", "Average Mortality Rate -- 56.63687",
#  
#  "Nantucket County (Highest income) -- Colon and rectum cancer	", "Average Mortality Rate -- 32.66684",
#  "Hampden County (Lowest income) -- Colon and rectum cancer	", "Average Mortality Rate -- 31.56224",
#  "Norfolk County (2nd Highest income) -- Colon and rectum cancer	", "Average Mortality Rate -- 30.52043",
#  "Berkshire County (2nd lowest income) -- Colon and rectum cancer	", "Average Mortality Rate -- 30.41453",
#  "Middlesex County (3rd highest income) -- Colon and rectum cancer	", "Average Mortality Rate -- 29.84633",
#  "Franklin County (3rd lowest income) -- Colon and rectum cancer	", "Average Mortality Rate -- 29.50000",
#)
#
#kable(
#    dict,
#    format = "html",
#    col.names = c("", ""),
#    caption = "Table 1. Data dictionary of explaining County Cancer type and Rates.") %>%
#    
#    group_rows(index = c("1st Highest Mortality Rate" = 6, "2nd Highest Mortality Rate" = 6, "3rd Highest Mortality Rate" = 6)) %>%
#    kable_styling(bootstrap_options = c("hover"),
#)
#
#

```

## 2.2 Question 2
### Wrangling, Preprocessing, and Mapping